# Alternative Simple AppImage Build Verification (without Docker complications)
# 
# This workflow verifies that AppImage build scripts are generated correctly
# and that the build process starts without Docker conflicts

name: AppImage Build Verification

on:
  push:
    branches: [ main, 17-feat-add-worklow-to-build-appimage ]
  pull_request:
    branches: [ main, 17-feat-add-worklow-to-build-appimage ]
  workflow_dispatch:

jobs:
  verify-script-generation:
    name: VÃ©rifier la gÃ©nÃ©ration des scripts AppImage
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Make scripts executable
      run: |
        chmod +x ./app-image-builder.sh
        
    - name: Generate AppImage build scripts
      run: ./app-image-builder.sh
      
    - name: âœ… Verify scripts were generated
      run: |
        echo "ğŸ” VÃ©rification de la gÃ©nÃ©ration des scripts..."
        
        if [ ! -d "appimage-build-full" ]; then
          echo "âŒ Ã‰CHEC: Le dossier appimage-build-full n'existe pas!"
          exit 1
        fi
        
        if [ ! -f "appimage-build-full/build-in-docker-full.sh" ]; then
          echo "âŒ Ã‰CHEC: Le script build-in-docker-full.sh n'a pas Ã©tÃ© gÃ©nÃ©rÃ©!"
          exit 1
        fi
        
        if [ ! -f "appimage-build-full/Dockerfile" ]; then
          echo "âŒ Ã‰CHEC: Le Dockerfile n'a pas Ã©tÃ© gÃ©nÃ©rÃ©!"
          exit 1
        fi
        
        echo "âœ… SUCCÃˆS: Tous les scripts ont Ã©tÃ© gÃ©nÃ©rÃ©s!"
        echo "ğŸ“‚ Contenu du dossier appimage-build-full:"
        ls -la appimage-build-full/
        
  verify-appimage-build:
    name: VÃ©rifier la gÃ©nÃ©ration de l'AppImage
    runs-on: ubuntu-22.04
    needs: verify-script-generation
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Docker
      run: |
        # Docker is pre-installed on GitHub Actions runners
        sudo systemctl start docker
        sudo systemctl enable docker
        # Verify Docker is working
        docker --version
        sudo docker info | grep "Server Version" || true
        
    - name: Make scripts executable
      run: |
        chmod +x ./app-image-builder.sh
        
    - name: Generate AppImage build scripts
      run: ./app-image-builder.sh
      
    - name: Build AppImage with Docker
      run: |
        cd appimage-build-full
        chmod +x ./build-in-docker-full.sh
        # Show the original script content
        echo "ğŸ“‹ Contenu original du script:"
        head -10 ./build-in-docker-full.sh
        # Modify the script to remove -it flags for CI environment
        sed -i 's/docker run -it/docker run/g' ./build-in-docker-full.sh
        # Also remove any standalone -it flags
        sed -i 's/ -it / /g' ./build-in-docker-full.sh
        echo "ğŸ“‹ Contenu modifiÃ© du script:"
        head -10 ./build-in-docker-full.sh
        # Use sudo for Docker commands to avoid permission issues
        sudo ./build-in-docker-full.sh
        
    - name: âœ… Verify AppImage was created
      run: |
        echo "ğŸ” VÃ©rification de la crÃ©ation de l'AppImage..."
        
        if [ ! -f "appimage-build-full/CoreTrace_Qt-1.0-x86_64.AppImage" ]; then
          echo "âŒ Ã‰CHEC: L'AppImage n'a pas Ã©tÃ© crÃ©Ã©e!"
          echo "ğŸ“‚ Contenu du dossier appimage-build-full:"
          ls -la appimage-build-full/
          exit 1
        fi
        
        echo "âœ… SUCCÃˆS: AppImage crÃ©Ã©e avec succÃ¨s!"
        
    - name: ğŸ“Š Display AppImage information
      run: |
        cd appimage-build-full
        echo "ğŸ“Š Informations sur l'AppImage:"
        echo "ğŸ“ Nom: CoreTrace_Qt-1.0-x86_64.AppImage"
        echo "ğŸ“ Taille: $(du -h CoreTrace_Qt-1.0-x86_64.AppImage | cut -f1)"
        echo "ğŸ” Type: $(file CoreTrace_Qt-1.0-x86_64.AppImage)"
        echo "âœ… Permissions: $(ls -la CoreTrace_Qt-1.0-x86_64.AppImage)"
        
    - name: ğŸ’¾ Upload AppImage as artifact
      uses: actions/upload-artifact@v4
      with:
        name: CoreTrace-Qt-AppImage-${{ github.sha }}
        path: appimage-build-full/CoreTrace_Qt-1.0-x86_64.AppImage
        retention-days: 7